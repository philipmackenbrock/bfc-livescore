<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Ranking</title>
  <style>
    body{font-family:inter,system-ui; background:#f7fafc; color:#111; padding:20px}
    .leaderboard{max-width:900px;margin:0 auto;background:#fff;border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;text-align:left;border-bottom:1px solid #eee}
    th{font-weight:600;color:#555}
    tr.rank-up{background:linear-gradient(90deg, rgba(224,255,230,0.6), transparent)}
    tr.rank-down{background:linear-gradient(90deg, rgba(255,230,230,0.6), transparent)}
    .pos{font-weight:700;font-size:1.05rem;width:56px}
    .score{font-weight:700;text-align:right}
    @media(max-width:640px){ .pos{width:40px} td{padding:8px} }
  </style>
</head>
<body>
  <div class="leaderboard">
    <h2>Live Ranking</h2>
    <table id="board">
      <thead><tr><th class="pos">#</th><th>Competitor</th><th>Club</th><th class="score">Score</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhYczAO1TgVwPQ_aUkEGccvDW8PJzUyNbXrwZ4jQlXYyNRobNBUKa-vGngFWHwnw/pub?gid=989351484&single=true&output=csv"; // e.g. from Google Sheets publish CSV link
let previousRanks = {};

async function fetchCSV(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error("Failed to fetch");
  const text = await res.text();
  return text;
}

function csvToArray(str){
  const rows = str.trim().split('\n').map(r => r.split(','));
  const headers = rows.shift().map(h => h.replace(/(^"|"$)/g,''));
  return rows.map(r => {
    const obj = {};
    r.forEach((cell,i)=> obj[headers[i]] = cell.replace(/(^"|"$)/g,''));
    return obj;
  });
}

function render(data){
  const tbody = document.querySelector('#board tbody');
  const newPrev = {};
  tbody.innerHTML = '';
  data.forEach((row, idx) => {
    const pos = idx + 1;
    const tr = document.createElement('tr');
    // detect rank move
    const id = row['Competitor'] || row['Name'] || ('row'+pos);
    const oldPos = previousRanks[id];
    if(oldPos !== undefined){
      if(oldPos > pos) tr.classList.add('rank-up');
      else if(oldPos < pos) tr.classList.add('rank-down');
    }
    newPrev[id] = pos;

    tr.innerHTML = `<td class="pos">${pos}</td>
                    <td>${row['Competitor'] || row['Name'] || ''}</td>
                    <td>${row['Club'] || ''}</td>
                    <td class="score">${row['Score'] || row['Points'] || ''}</td>`;
    tbody.appendChild(tr);
  });
  previousRanks = newPrev;
}

async function refresh(){
  try{
    const text = await fetchCSV(CSV_URL);
    const arr = csvToArray(text);
    render(arr);
  }catch(err){
    console.error(err);
  }
}

// initial load + poll every 8 seconds
refresh();
setInterval(refresh, 8000);
</script>
</body>
</html>
